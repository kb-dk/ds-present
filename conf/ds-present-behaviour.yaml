#
# This config contains behaviour data: Thread allocation, allowed fields for lookup, limits for arguments etc.
#
# The behaviour config is normally controlled by developers and is part of the code repository.
# Sensitive information such as machine names and user/passwords should not be part of this config.
#
# It will be automatically merged with the environment config when accessed through the
# application config system.
#
#
config:
  # List of backing storages. This information should be overridden in ds-present-environment.yaml
  storages:
    # There can be multiple defined storages. The outer YAML key is used as the ID for the storage.
    - main:
        # If default is true, this will be the default storage for collections.
        # The default storage choice can be overridden in a collection with the 'storage' property
        default: true
        # Backends contains a list of one or more implementations and their configuration, with the primary key being
        # the implementation (aka type) of the backend
        #
        # Available backends are
        # ds-storage: Connection to a https://github.com/kb-dk/ds-storage/ instance
        # folder:     Local files under the stated folder. Use only for test as the implementation in unsecure
        backends:
          # The ds-storage backend connects to a running https://github.com/kb-dk/ds-storage/ instance
          - ds-storage:
              # The name of the machine running the service. Mandatory
              host: 'localhost'
              # The port for the service. Mandatory
              port: 8080
              # The path the the service. Optional, default is 'ds-storage/v1/'
              basepath: 'ds-storage/v1/'
              # The connection scheme: http or https. Optional, default is http for localhost, https for everything else
              scheme: 'http'
    - test:
        # If there is more that one backend implementation, the property 'order' controls how they are queried:
        # * parallel:   All backends are queried in parallel. Whoever answers with a record first wins.
        # * sequential: All backends are queried one at a time in the order in this configuration.
        #               When a backend responds with a record, itertaion is stopped and the record is returned
        # Optional, default value is 'sequential'
        order: sequential
        backends:
          # The folder backend expects content to be stored in a local folder. The ID is used as the file name.
          # WARNING: Insecure implementation (files outside of the folder can be read). Do not use for production!
          # The src/test/resources/xml/corpus contains a small sample corpus. this is only likely to work when
          # running with `mvn jetty:run` and even the we're unsure of the current folder, so we se up alternatives.
          - folder:
              root: 'src/test/resources/xml/corpus' # Expected
              # Whether or not remove ID-prefix (the part from the beginning to the first `:` (inclusive) of the ID)
              # from the ID when perforaing the lookup. Optional, default is true.
              stripprefix: true
          - folder:
              root: '../src/test/resources/xml/corpus' # Maybe PWD is target/
          - folder:
              root: 'ds-present/src/test/resources/xml/corpus' # Maybe PWD is outsid eof the checkout (unlikely)

  # Settings for handling at the record level
  record:
    id:
      # Pattern for acceptable record IDs. Must contain exactly 2 capturing group, the first being the collection prefix
      # and the second being the collection-specifix par of the ID
      # Mandatory. Suggested value: '$([a-z][0-9][.]):([a-z][0-9][.-_])$', e.g. 'images.dsfl:image1234'
      pattern: '$([a-z][0-9][.]):([a-z][0-9][.-_])$'

  # The collections available for this instance of ds-present 
  collections:
    # General note: All collections are expected to support at least the views raw, mods, jsonld and solrjson.
    # If any of those are not supported, the transformer 'fail' should be used with a telling message.

    # Straight forward collection with the core format being MODS
    - dsfl: # ds-present internal
        prefix: 'images-dsfl' # The prefix to match on incoming IDs
        description: 'Images from the collection Danmark Set Fra Luften'
        # Different views on the material. Note that all collections has at least mods, jsonld and solrjson as views
        views:
          - raw:
              mime: 'text/plain'
              transformers:
                - identity:
          - mods:
              mime: 'application/xml'
              transformers:
                - identity: # No transformation steps as mods is the core format for images-dsfl
          - jsonld:
              mime: 'application/json'
              transformers:
                - xslt:
                    stylesheet: 'xslt/mods2jsonld.xsl'
          - solrjson:
              mime: 'application/json'
              transformers:
                - xslt:
                    stylesheet: 'xslt/mods2solr.xsl'

    # Internal format is TEI 
    - manuscripts:
        prefix: 'text-manuscripts'
        description: 'Multi page manuscripts'
        views:
          - raw:
              mime: 'text/plain'
              transformers:
                - identity:
          - mods:
              mime: 'application/xml'
              transformers:
                - xslt:
                    stylesheet: 'path/to/xslts/tei2mods.xsl'
          - jsonld:
              mime: 'application/json'
              transformers:
                # Chained re-use of existing XSLTs 
                - xslt:
                    stylesheet: 'path/to/xslts/tei2mods.xsl'
                - xslt:
                    stylesheet: 'path/to/xslts/mods2jsonld.xsl'
          - solrjson:
              mime: 'application/json'
              transformers:
                - xslt:
                    stylesheet: 'path/to/xslts/tei2mods.xsl'
                - xslt:
                    stylesheet: 'path/to/xslts/mods2solr.xsl'
          - alto:
              mime: 'application/xml'
              transformers:
                - xslt:
                    stylesheet: 'path/to/xslts/tei2mods.xsl'
                # Demonstration of special handling by a Java class. Maybe this is overengineering?
                - java:
                    class: 'dk.db.present.transformers.RetrieveALTOForMODS.class'
                    javaconfig: # This configuration is given to the constructor for RetrieveALTOForMODS
                      - alto_source: 'http://localhost:8765/altoservice/v2'

    # Some fantasy source where the metadata is delivered in something neither XML nor JSON
    - problemchild:
        prefix: 'strange-times'
        storage: 'special'
        description: 'Images from the site Strange Times. NOTE: MODS is not available for this source'
        views:
          # No raw defined
          - mods:
              mime: 'application/xml'
              transformers:
                - fail:
                    message: 'MODS not supported for material from Strange Times'
          - jsonld:
              mime: 'application/json'
              transformers:
                - java:
                    class: 'dk.db.present.transformers.ST2JSON_LD.class'
          - solrjson:
              mime: 'application/json'
              transformers:
                - java:
                    class: 'dk.db.present.transformers.ST2Solr.class'

